"use strict";(self["webpackChunkhotel_frontend"]=self["webpackChunkhotel_frontend"]||[]).push([[379],{2034:function(t,e,s){s.d(e,{A:function(){return m}});var o=function(){var t=this,e=t._self._c;return e("header",{staticClass:"page-header"},[e("h1",{staticClass:"title"},[t._v(t._s(t.title))]),e("p",{staticClass:"intro"},[t._v(t._s(t.intro))]),e("div",{staticClass:"line"})])},a=[],r={name:"hotel-header",props:{title:{type:String,required:!0,default:"默认标题"},intro:{type:String,default:"简单介绍当前模块的内容"}}},i=r,l=s(1656),n=(0,l.A)(i,o,a,!1,null,null,null),m=n.exports},1669:function(t,e,s){s.r(e),s.d(e,{default:function(){return F}});var o=function(){var t=this,e=t._self._c;return e("el-container",{staticClass:"room-container"},[e("Header",{attrs:{title:t.pageTitle,intro:t.pageIntro}}),e("Bigbox"),e("div",{staticClass:"search-box"},[e("el-button",{attrs:{type:"danger",icon:"el-icon-minus"},on:{click:t.delRoomsConfirm}},[t._v("批量注销")]),e("el-input",{staticClass:"search-ipt",attrs:{placeholder:"输入查询关键字"},model:{value:t.search,callback:function(e){t.search=e},expression:"search"}}),e("span",{staticStyle:{color:"transparent","background-color":"transparent",border:"0",width:"100px"}})],1),e("el-table",{ref:"roomersTable",staticStyle:{width:"100%"},attrs:{data:t.roomersList,"highlight-selection-row":""},on:{"selection-change":t.selectListener}},[e("el-table-column",{attrs:{type:"selection",width:"90",align:"center"}}),e("el-table-column",{attrs:{prop:"id",label:"ID",width:"90",align:"center",sortable:""}}),e("el-table-column",{attrs:{prop:"roomername",label:"姓名",align:"center"}}),e("el-table-column",{attrs:{prop:"status",label:"状态",align:"center",filters:t.roomerStatusArr,"filter-method":t.filterHandler},scopedSlots:t._u([{key:"default",fn:function({row:s}){return[e("el-tag",{staticStyle:{width:"50%",height:"90%","font-size":"medium","text-align":"center"},attrs:{type:t.getStatusClass(s.status),effect:"dark"}},[t._v(t._s(s.status))])]}}])}),e("el-table-column",{attrs:{prop:"roomnum",label:"房号",align:"center",sortable:""}}),e("el-table-column",{attrs:{prop:"cardid",label:"房卡ID",width:"90",align:"center"}}),e("el-table-column",{attrs:{prop:"time",label:"变更时间",align:"center"}}),e("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:t._u([{key:"default",fn:function({row:s}){return[e("el-button",{attrs:{size:"medium",type:"primary"},on:{click:function(e){return t.checkDetails(s)}}},[t._v(" 查看详情 ")])]}}])})],1),e("el-dialog",{staticClass:"details-dialog",attrs:{title:"信息变更",visible:t.detailsVisible,width:"40%",center:""},on:{"update:visible":function(e){t.detailsVisible=e}}},[e("el-form",{attrs:{model:t.detailsForm,"label-position":"left","label-width":"80px"}},[e("el-form-item",{attrs:{label:"ID"}},[e("el-input",{attrs:{autocomplete:"off",disabled:""},model:{value:t.detailsForm.id,callback:function(e){t.$set(t.detailsForm,"id",e)},expression:"detailsForm.id"}})],1),e("el-form-item",{attrs:{label:"姓名"}},[e("el-input",{attrs:{autocomplete:"off"},model:{value:t.detailsForm.roomername,callback:function(e){t.$set(t.detailsForm,"roomername",e)},expression:"detailsForm.roomername"}})],1),e("el-form-item",{attrs:{label:"状态"}},[e("el-select",{model:{value:t.detailsForm.status,callback:function(e){t.$set(t.detailsForm,"status",e)},expression:"detailsForm.status"}},t._l(t.roomerStatusArr,(function(t){return e("el-option",{key:t.value,attrs:{label:t.text,value:t.value}})})),1)],1),e("el-form-item",{attrs:{label:"房号"}},[e("el-input",{attrs:{autocomplete:"off"},model:{value:t.detailsForm.roomnum,callback:function(e){t.$set(t.detailsForm,"roomnum",e)},expression:"detailsForm.roomnum"}})],1),e("el-form-item",{attrs:{label:"房卡ID"}},[e("el-input",{attrs:{autocomplete:"off"},model:{value:t.detailsForm.cardid,callback:function(e){t.$set(t.detailsForm,"cardid",e)},expression:"detailsForm.cardid"}})],1),e("el-form-item",{attrs:{label:"变更时间"}},[e("el-input",{attrs:{autocomplete:"off",disabled:""},model:{value:t.detailsForm.time,callback:function(e){t.$set(t.detailsForm,"time",e)},expression:"detailsForm.time"}})],1)],1),e("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.detailsVisible=!1}}},[t._v("取 消")]),e("el-button",{attrs:{type:"primary"},on:{click:t.handleChangeRoomer}},[t._v("确 定")])],1)],1)],1)},a=[],r=(s(8111),s(2489),s(116),s(7588),s(1701),s(3579),s(3518)),i=s(3022),l=s(2034),n=s(4166),m=s(1576),d=s.n(m);const c=n.A.room,u=n.A.roomer,h=n.A.card;var p={name:"hotel-roomer",components:{Header:l.A,Bigbox:i.A},data(){return{pageTitle:"客户信息",pageIntro:"当前板块可查询所有客户的入住历史",search:"",roomerStatusArr:[{text:"已预订",value:"已预订"},{text:"已入住",value:"已入住"}],mulSelRoomers:[],detailsForm:{},rowSnapshot:{},detailsVisible:!1}},computed:{...(0,r.L8)(["roomersData","roomsData","cardsInfo"]),roomersList(){const t=this.roomersData.map((t=>{const e={...t};return e.time=d()(t.time).format("YYYY-MM-DD HH:mm:ss"),e}));return this.search?t.filter((t=>Object.keys(t).some((e=>t[e]&&t[e].toString().includes(this.search))))):t},checkOutList(){return this.delSearch?this.roomersData.filter((t=>!["",null,void 0].includes(t.roomername)&&(!!["已预订","已入住"].includes(t.status)&&Object.keys(t).some((e=>!["roompic","lockcode"].includes(e)&&(t[e]&&t[e].toString().includes(this.delSearch))))))):[]}},methods:{checkDetails(t){this.detailsForm={...t},this.rowSnapshot={...t},this.detailsVisible=!0},async handleChangeRoomer(){const t=this.detailsForm.roomnum!==this.rowSnapshot.roomnum;if(t){const t=this.detailsForm.roomnum;let e=!1;if(this.roomsData.some((s=>s.roomnum===t&&(e=("空闲"===s.status&&s.roomername,!0),!0))),!e)return this.$message.error(`${t}号房间状态不可被更改，请查看房间详情`),!1}this.detailsForm.roomerid=this.detailsForm.id,this.detailsForm.time=d()().unix(),this.detailsForm.cardid=Number(this.detailsForm.cardid)||void 0;const{data:e}=await u.ReqUpdateRoomerData(this.detailsForm);if(0===e.status){let e;e=t?{roomid:this.roomsData.find((t=>t.roomnum===this.rowSnapshot.roomnum)).id,roomnum:this.rowSnapshot.roomnum,status:"待铺新",roomtype:void 0,lockcode:void 0,roompic:void 0,roomername:null,cardid:null}:{roomid:this.roomsData.find((t=>t.roomnum===this.detailsForm.roomnum)).id,roomnum:this.detailsForm.roomnum,status:this.detailsForm.status,roomtype:void 0,lockcode:void 0,roompic:void 0,roomername:this.detailsForm.roomername,cardid:this.detailsForm.cardid};const{data:s}=await c.ReqUpdateRoomData(e);if(0===s.status)if(t){const t={roomid:this.roomsData.find((t=>t.roomnum===this.detailsForm.roomnum)).id,roomnum:this.detailsForm.roomnum,status:this.detailsForm.status,roomtype:void 0,lockcode:void 0,roompic:void 0,roomername:this.detailsForm.roomername,cardid:this.detailsForm.cardid},{data:e}=await c.ReqUpdateRoomData(t);0===e.status?(this.$store.dispatch("getRoomsData"),this.$store.dispatch("getRoomersData"),this.$message.success("房客状态已变更"),this.detailsVisible=!1):e.data.length>0?e.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(e.message)}else this.$store.dispatch("getRoomsData"),this.$store.dispatch("getRoomersData"),this.$message.success("房客状态已变更"),this.detailsVisible=!1;else s.data.length>0?s.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(s.message)}else e.data.length>0?e.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(e.message)},getStatusClass(t){switch(t){case"已预订":return"";case"已入住":return"success";case"异常":return"danger"}return""},filterHandler(t,e,s){const o=s.property;return e[o]===t},selectListener(t){this.mulSelRoomers=t},delRoomsConfirm(){if(0===this.mulSelRoomers.length)return this.$message.info("至少要选中一个房客");const t=this.mulSelRoomers.map((t=>t.roomername));this.$confirm(`确定注销${t.join("\n")}共${t.length}个房客吗?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.delRoomersFn()})).catch((()=>this.$refs.roomersTable.clearSelection()))},async delRoomersFn(){const t=this.mulSelRoomers.map((async t=>{try{const{data:e}=await u.ReqDelRoomer(t.roomername);if(0!==e.status)return e.data.length>0?e.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(e.message),null;{const e=this.roomsData.find((e=>e.roomnum===t.roomnum)).id,s={roomid:e,roomername:null,cardid:null,status:"待铺新"},{data:o}=await c.ReqUpdateRoomData(s);if(0===o.status){const e=this.cardsInfo.find((e=>e.id===t.cardid));if(e){const t={id:e.id,uid:e.uid,roomnum:null,status:"锁卡中",cardtype:"房客卡",holdername:null},{data:s}=await h.ReqUpdateCardInfo(t);if(0===s.status)return s;s.data.length>0?s.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(s.message)}this.$store.dispatch("getCardsInfo"),this.$store.dispatch("getRoomersData"),this.$store.dispatch("getRoomsData"),this.$store.dispatch("getOpsLogsData"),this.$message.success("房客已退房"),this.checkOutVisible=!1,this.delSearch=""}else o.data.length>0?o.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(o.message)}}catch(e){console.log(e);const t=e.response;return console.error(t&&t.message||e),null}})),e=await Promise.all(t),s=e.filter((t=>t));s.length>0?(s.length<this.mulSelRoomers.length?this.$message.warning("选中的房客部分删除"):this.$message.success("选中的房客全部删除"),this.$store.dispatch("getRoomersData")):console.error("房客删除操作全部失败")}},async created(){this.$store.dispatch("getRoomersData"),this.$store.dispatch("getRoomsData")}},f=p,g=s(1656),b=(0,g.A)(f,o,a,!1,null,"54116060",null),F=b.exports}}]);