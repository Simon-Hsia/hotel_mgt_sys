"use strict";(self["webpackChunkhotel_frontend"]=self["webpackChunkhotel_frontend"]||[]).push([[143],{2524:function(t,a,e){e.d(a,{A:function(){return O}});var s=function(){var t=this,a=t._self._c;return a("el-container",{staticClass:"card-dispenser-container"},[a("div",{staticClass:"card-box"},[a("el-button",{staticClass:"big-btn big-btn-card",attrs:{plain:"",type:"primary"},on:{click:t.localHandle}},[t._v("房卡办理(本地)")]),a("el-button",{staticClass:"big-btn big-btn-card",attrs:{plain:"",type:"success"},on:{click:t.virtualHandle}},[t._v("房卡办理(远程)")])],1),a("el-dialog",{attrs:{title:t.localObj.dialogTitle,visible:t.localObj.localVisible,width:"30%",center:"","before-close":t.handleLocalClose},on:{"update:visible":function(a){return t.$set(t.localObj,"localVisible",a)}}},[t.localObj.loading?a("h3"):t._e(),a("el-form",{directives:[{name:"loading",rawName:"v-loading",value:t.localObj.loading,expression:"localObj.loading"}],attrs:{model:t.cardForm,"label-position":"left","label-width":"120px"}},[t.localObj.isNewSign?t._e():a("el-form-item",{attrs:{label:"ID"}},[a("span",[t._v(t._s(t.cardForm.id))])]),a("el-form-item",{attrs:{label:"序列号"}},[a("span",[t._v(t._s(t.cardForm.uid))])]),a("el-form-item",{attrs:{label:"房号"}},[a("el-input",{attrs:{autocomplete:"off"},model:{value:t.cardForm.roomnum,callback:function(a){t.$set(t.cardForm,"roomnum",a)},expression:"cardForm.roomnum"}})],1),t.localObj.isNewSign?t._e():a("el-form-item",{attrs:{label:"状态"}},[a("span",[t._v(t._s(t.cardForm.status))])]),a("el-form-item",{attrs:{label:"房卡类型"}},[a("el-select",{attrs:{placeholder:"请选择"},model:{value:t.cardForm.cardtype,callback:function(a){t.$set(t.cardForm,"cardtype",a)},expression:"cardForm.cardtype"}},t._l(t.cardtypeFilterArr,(function(t){return a("el-option",{key:t.value,attrs:{label:t.text,value:t.value}})})),1)],1),a("el-form-item",{attrs:{label:"持有者姓名"}},[a("el-input",{attrs:{autocomplete:"off"},model:{value:t.cardForm.holdername,callback:function(a){t.$set(t.cardForm,"holdername",a)},expression:"cardForm.holdername"}})],1)],1),t.localObj.loading?t._e():a("footer",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t.localObj.isNewSign?a("el-button",{attrs:{type:"success"},on:{click:t.submitNewCard}},[t._v("注 册")]):t._e(),t.localObj.isNewSign?t._e():a("el-button",{attrs:{size:"medium",type:"使用中"===t.cardForm.status?"warning":"success"},on:{click:function(a){return t.changeCardStatus(t.cardForm)}}},[t._v(" "+t._s("使用中"===t.cardForm.status?"一键锁卡":"一键解锁")+" ")]),t.localObj.isNewSign?t._e():a("el-button",{attrs:{type:"primary"},on:{click:t.updateCard}},[t._v("更 新")]),t.localObj.isNewSign?t._e():a("el-button",{attrs:{type:"danger"},on:{click:t.resetCard}},[t._v("重 置")])],1)],1)],1)},r=[];e(8111),e(116),e(7588);class i{constructor(){this.buffer=[],this._readOffset=0}initWithUint8Array(t,a){a=a||t.length,this.buffer=[];for(let e=0;e<a&&e<t.length;e++)this.buffer[e]=t[e];this._readOffset=0}getUint8(){return this._readOffset+1>this.buffer.length?null:this.buffer[this._readOffset++]}getUnicodeWithUtf8(){let t;const a=this.getUint8();if(null===a)return null;let e=7;while(1===(a>>e&1))e--;e=7-e,t=0===e?a:a&Math.pow(2,7-e)-1;for(let s=1;s<e;s++){const s=this.getUint8();if(128!==(128&s)){t=a,this.changeReadOffset(1-e),e=0;break}t=t<<6|63&s}return{unicode:t,len:0===e?1:e}}getStringWithUtf8(t){if(t<1)return"";if(this._readOffset+t>this.buffer.length)return"";let a="",e=0;while(e<t){const t=this.getUnicodeWithUtf8();if(!t)break;if(e+=t.len,t.unicode<65536)a+=String.fromCharCode(t.unicode);else{const e=t.unicode-65536,s=e>>10|55296,r=1023&e|56320;a+=String.fromCharCode(s,r)}}return a}changeReadOffset(t){this._readOffset=Math.max(0,Math.min(this.buffer.length,this._readOffset+t))}}var l=new i,o=e(1576),d=e.n(o),c=e(4166),n=e(3518);const h=c.A.card,u=c.A.room,m=c.A.roomer;var g={name:"hotel-carddispenser",data(){return{localObj:{localVisible:!1,usbIdObj:{usbProductId:null,usbVendorId:null},baudRate:115200,port:null,reader:null,reading:!1,loading:!0,uid:null,isNewSign:!1,dialogTitle:"请放置房卡于发卡器上"},cardForm:{},cardtypeFilterArr:[{text:"房客卡",value:"房客卡"},{text:"员工卡",value:"员工卡"}]}},computed:{...(0,n.L8)(["cardsInfo","roomsData","roomersData"])},watch:{"localObj.uid":{handler(t,a){if(t){const a=this.cardsInfo.find((a=>a.uid===t));a?(this.localObj.dialogTitle="已查询到信息",this.cardForm={...a}):(this.localObj.isNewSign=!0,this.localObj.dialogTitle="当前为新卡",this.cardForm={uid:t}),this.localObj.loading=!1}},deep:!0}},methods:{async localHandle(){this.localObj.port=await navigator.serial.requestPort(),this.localObj.usbIdObj={usbProductId:this.localObj.port.getInfo().usbProductId,usbVendorId:this.localObj.port.getInfo().usbVendorId};try{await this.localObj.port.open({baudRate:115200}),this.listenReceived(),this.localObj.localVisible=!0}catch(t){this.$message.error("发卡器打开失败"),console.log(t)}},async virtualHandle(){this.localObj.localVisible=!0;const{data:t}=await h.ReqGetDispensingCard();if(0===t.status){const a=t.data;console.log(t),a?(a.id?(this.localObj.dialogTitle="已查询到信息",this.cardForm={...a}):(this.localObj.isNewSign=!0,this.localObj.dialogTitle="当前为新卡",this.cardForm={uid:a.uid}),this.cardForm={...a},this.localObj.loading=!1,this.$message.success("已获取房卡信息")):(this.localObj.localVisible=!0,this.$message.error("远程操作异常!"))}else this.localObj.localVisible=!0,this.$message.error(t.message)},async submitNewCard(){const{data:t}=await h.ReqAddCard(this.cardForm);if(0===t.status){this.handleLocalClose(),this.$store.dispatch("getCardsInfo"),this.$message.success(t.message);const a=this.cardsInfo.find((t=>t.uid===this.cardForm.uid)).id;await this.updateOtherData(a)}else t.data.length>0?t.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(t.message)},async handleLocalClose(){this.localObj.reading&&(this.localObj.reading=!1,await(this.localObj.reader?.cancel())),this.localObj.uid=null,this.localObj.loading=!1,this.localObj={localVisible:!1,usbIdObj:{usbProductId:null,usbVendorId:null},baudRate:115200,port:null,reader:null,reading:!1,loading:!0,uid:null,isNewSign:!1,dialogTitle:"请放置房卡于发卡器上"},this.cardForm={}},async changeCardStatus(){const t="使用中"===this.cardForm.status?"锁卡中":"使用中",a={id:this.cardForm.id,uid:this.cardForm.uid,status:t},{data:e}=await h.ReqUpdateCardInfo(a);if(0===e.status){await this.$store.dispatch("getCardsInfo");const a=this.cardsInfo.find((t=>t.uid===this.cardForm.uid));this.cardForm={...a},this.$message.success("房卡已"+("使用中"===t?"解锁":"上锁"))}else e.data.length>0?e.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(e.message)},async resetCard(){const t={id:this.cardForm.id,uid:this.cardForm.uid,roomnum:null,status:"锁卡中",cardtype:"房客卡",holdername:null},{data:a}=await h.ReqUpdateCardInfo(t);if(0===a.status){await this.$store.dispatch("getCardsInfo");const t=this.cardsInfo.find((t=>t.uid===this.cardForm.uid));t?(this.cardForm={...t},this.$message.success("重置成功!"),await this.updateOtherData(this.cardForm.id)):this.$message.error("重置操作异常!")}else a.data.length>0?a.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(a.message)},async updateCard(){const{data:t}=await h.ReqUpdateCardInfo(this.cardForm);if(0===t.status){await this.$store.dispatch("getCardsInfo");const t=this.cardsInfo.find((t=>t.uid===this.cardForm.uid));t?(this.cardForm={...t},this.$message.success("更新成功!"),await this.updateOtherData(this.cardForm.id)):this.$message.error("更新操作异常!")}else t.data.length>0?t.data.forEach((t=>{this.$message.error(t.message)})):this.$message.error(t.message)},async updateOtherData(t=null){let a=null;if(this.cardForm.roomnum&&(a=this.roomsData.find((t=>t.roomnum===this.cardForm.roomnum)).id),a){const e={roomid:a,cardid:t},{data:s}=await u.ReqUpdateRoomData(e);0===s.status?(this.$store.dispatch("getRoomsData"),this.$message.success(s.message)):s.data.length>0&&s.data.forEach((t=>{this.$message.error(t.message)}))}let e=null;if(this.cardForm.holdername&&(e=this.roomersData.find((t=>t.roomername===this.cardForm.holdername)).id),e){const a={roomerid:e,cardid:t,time:d()().unix()},{data:s}=await m.ReqUpdateRoomerData(a);0===s.status?(this.$store.dispatch("getRoomersData"),this.$message.success(s.message)):s.data.length>0&&s.data.forEach((t=>{this.$message.error(t.message)}))}},async listenReceived(){if(this.localObj.reading)this.$message.warning("正在寻卡中...");else{this.localObj.reading=!0;while(this.localObj.port.readable&&this.localObj.reading){this.localObj.reader=this.localObj.port.readable.getReader();try{while(1){const{value:t,done:a}=await this.localObj.reader.read();if(a)break;l.initWithUint8Array(t);const e=l.getStringWithUtf8(t.length),s=e.indexOf("uid:");if(-1!==s){let t=s;while(t<e.length&&"\n"!==e[t])t++;t<e.length&&(this.localObj.uid=e.slice(s+4,t).trim())}}}catch(t){console.log("err",t)}finally{this.localObj.reader.releaseLock()}}await this.localObj.port.close(),this.localObj.port=null}}}},b=g,f=e(1656),p=(0,f.A)(b,s,r,!1,null,"2f95340c",null),O=p.exports}}]);